{% extends 'base.html.twig' %}

{% set typ_konta = typ_konta|default('uzytkownik') %}

{% block title %}Booker - załóż konto już teraz!{% endblock %}

{% block header %}
	{% include 'partials/header-alt.html.twig' %}
{% endblock %}

{% block body %}
<div class="flex justify-center items-center py-[70px] bg-gray-100 py-8">
	<div class="bg-white shadow-lg rounded-lg p-8 max-w-5xl w-full">
		<div class="flex flex-col items-center gap-2 mb-8">
			<h1 class="text-2xl font-bold text-center">Rejestracja</h1>
			<p class="text-sm text-gray-500 text-center">Wybierz typ konta, a następnie uzupełnij dane.</p>

			<div id="formAlert" class="hidden mt-3 w-full max-w-2xl rounded-lg border border-red-200 bg-red-50 px-4 py-3 text-sm text-red-700">
				Uzupełnij poprawnie pola oznaczone błędem (najedź na ikonę “i”, aby zobaczyć szczegóły).
			</div>
		</div>

		{{ form_start(registrationForm, {'attr': {'class': 'space-y-6', 'id': 'registrationForm'}}) }}

		<div class="flex justify-center">
			<div class="w-full max-w-lg">
				{{ form_label(registrationForm.accountType, 'Typ konta', {'class': 'block text-sm font-medium text-gray-700 mb-3 text-center'}) }}

				<div class="inline-flex w-full justify-center">
					<div class="relative w-full rounded-xl bg-gray-100 p-1 shadow-inner overflow-hidden">
						<span id="accountTypeIndicator" class="pointer-events-none absolute top-1 bottom-1 left-1 w-1/2 rounded-lg bg-white shadow transition-transform duration-200 ease-out"></span>

						<div class="relative grid grid-cols-2">
							{% for choice in registrationForm.accountType %}
								<div class="relative">
									{{ form_widget(choice, {
										'attr': {
											'class': 'sr-only',
											'data-role': 'accountTypeRadio'
										}
									}) }}

									{{ form_label(choice, null, {
										'label_attr': {
											'class': 'accountTypeBtn block cursor-pointer select-none rounded-lg px-4 py-3 text-center text-sm font-semibold text-gray-600 transition-colors duration-200'
										}
									}) }}
								</div>
							{% endfor %}
						</div>
					</div>
				</div>

				{{ form_errors(registrationForm.accountType) }}
			</div>
		</div>

		<div id="formGrid" class="reg-grid grid grid-cols-1 lg:grid-cols-2 gap-8">
			<div id="userFields" class="space-y-6">
				<div class="grid grid-cols-1 md:grid-cols-2 gap-4">
					<div>
						{{ form_label(registrationForm.email, 'E-mail', {'class': 'block text-sm font-medium text-gray-700'}) }}
						<div class="field-wrap relative">
							{{ form_widget(registrationForm.email, {'attr': {
								'class': 'mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500',
								'data-validate': 'required|email'
							}}) }}
							<span class="error-indicator"></span>
						</div>
						{{ form_errors(registrationForm.email) }}
					</div>
					<div>
						{{ form_label(registrationForm.phone, 'Nr. Telefonu', {'class': 'block text-sm font-medium text-gray-700'}) }}
						<div class="field-wrap relative">
							{{ form_widget(registrationForm.phone, {'attr': {
								'class': 'mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500',
								'data-validate': 'required'
							}}) }}
							<span class="error-indicator"></span>
						</div>
						{{ form_errors(registrationForm.phone) }}
					</div>
				</div>

				<div class="grid grid-cols-1 md:grid-cols-2 gap-4">
					<div>
						{{ form_label(registrationForm.name, 'Imię', {'class': 'block text-sm font-medium text-gray-700'}) }}
						<div class="field-wrap relative">
							{{ form_widget(registrationForm.name, {'attr': {
								'class': 'mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500',
								'data-validate': 'required'
							}}) }}
							<span class="error-indicator"></span>
						</div>
						{{ form_errors(registrationForm.name) }}
					</div>
					<div>
						{{ form_label(registrationForm.surname, 'Nazwisko', {'class': 'block text-sm font-medium text-gray-700'}) }}
						<div class="field-wrap relative">
							{{ form_widget(registrationForm.surname, {'attr': {
								'class': 'mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500',
								'data-validate': 'required'
							}}) }}
							<span class="error-indicator"></span>
						</div>
						{{ form_errors(registrationForm.surname) }}
					</div>
				</div>

				<div>
					{{ form_label(registrationForm.password.first, 'Hasło', {'class': 'block text-sm font-medium text-gray-700'}) }}
					<div class="field-wrap relative">
						{{ form_widget(registrationForm.password.first, {'attr': {
							'class': 'mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500',
							'data-validate': 'required|min:6',
							'data-password': 'first'
						}}) }}
						<span class="error-indicator"></span>
					</div>
					{{ form_errors(registrationForm.password.first) }}
				</div>

				<div>
					{{ form_label(registrationForm.password.second, 'Potwierdź hasło', {'class': 'block text-sm font-medium text-gray-700'}) }}
					<div class="field-wrap relative">
						{{ form_widget(registrationForm.password.second, {'attr': {
							'class': 'mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500',
							'data-validate': 'required',
							'data-password': 'second'
						}}) }}
						<span class="error-indicator"></span>
					</div>
					{{ form_errors(registrationForm.password.second) }}
				</div>
			</div>

			<div id="businessFields" class="hidden">
				<div class="h-full rounded-xl border border-gray-200 bg-gray-50 p-6 shadow-sm">
					<div class="flex items-start justify-between gap-4 mb-5">
						<div>
							<h3 class="text-lg font-semibold text-gray-900">Informacje firmy</h3>
							<p class="text-sm text-gray-600 mt-1">Te dane są wymagane tylko dla konta biznesowego.</p>
						</div>
						<span class="inline-flex items-center rounded-full bg-indigo-100 px-3 py-1 text-xs font-semibold text-indigo-700">Biznes</span>
					</div>

					<div class="space-y-4">
						<div class="grid grid-cols-1 md:grid-cols-2 gap-4">
							<div>
								{{ form_label(registrationForm.businessName, 'Nazwa Firmy', {'class': 'block text-sm font-medium text-gray-700'}) }}
								<div class="field-wrap relative">
									{{ form_widget(registrationForm.businessName, {'attr': {
										'class': 'mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500',
										'data-validate': 'required',
										'data-business-only': '1'
									}}) }}
									<span class="error-indicator"></span>
								</div>
								{{ form_errors(registrationForm.businessName) }}
							</div>
							<div>
								{{ form_label(registrationForm.formalBusinessName, 'Formalna nazwa firmy', {'class': 'block text-sm font-medium text-gray-700'}) }}
								<div class="field-wrap relative">
									{{ form_widget(registrationForm.formalBusinessName, {'attr': {
										'class': 'mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500',
										'data-validate': 'required',
										'data-business-only': '1'
									}}) }}
									<span class="error-indicator"></span>
								</div>
								{{ form_errors(registrationForm.formalBusinessName) }}
							</div>
						</div>

						<div>
							{{ form_label(registrationForm.address, 'Adres', {'class': 'block text-sm font-medium text-gray-700'}) }}
							<div class="field-wrap relative">
								{{ form_widget(registrationForm.address, {'attr': {
									'class': 'mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500',
									'data-validate': 'required',
									'data-business-only': '1'
								}}) }}
								<span class="error-indicator"></span>
							</div>
							{{ form_errors(registrationForm.address) }}
						</div>

						<div class="grid grid-cols-1 md:grid-cols-2 gap-4">
							<div>
								{{ form_label(registrationForm.city, 'Miasto', {'class': 'block text-sm font-medium text-gray-700'}) }}
								<div class="field-wrap relative">
									{{ form_widget(registrationForm.city, {'attr': {
										'class': 'mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500',
										'data-validate': 'required',
										'data-business-only': '1'
									}}) }}
									<span class="error-indicator"></span>
								</div>
								{{ form_errors(registrationForm.city) }}
							</div>
							<div>
								{{ form_label(registrationForm.postalCode, 'Kod pocztowy', {'class': 'block text-sm font-medium text-gray-700'}) }}
								<div class="field-wrap relative">
									{{ form_widget(registrationForm.postalCode, {'attr': {
										'class': 'mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500',
										'data-validate': 'required',
										'data-business-only': '1'
									}}) }}
									<span class="error-indicator"></span>
								</div>
								{{ form_errors(registrationForm.postalCode) }}
							</div>
						</div>

						<div class="grid grid-cols-1 md:grid-cols-2 gap-4">
							<div>
								{{ form_label(registrationForm.businessPhone, 'Nr. Telefonu', {'class': 'block text-sm font-medium text-gray-700'}) }}
								<div class="field-wrap relative">
									{{ form_widget(registrationForm.businessPhone, {'attr': {
										'class': 'mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500',
										'data-validate': 'required',
										'data-business-only': '1'
									}}) }}
									<span class="error-indicator"></span>
								</div>
								{{ form_errors(registrationForm.businessPhone) }}
							</div>
							<div>
								{{ form_label(registrationForm.businessEmail, 'E-mail firmy', {'class': 'block text-sm font-medium text-gray-700'}) }}
								<div class="field-wrap relative">
									{{ form_widget(registrationForm.businessEmail, {'attr': {
										'class': 'mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500',
										'data-validate': 'required|email',
										'data-business-only': '1'
									}}) }}
									<span class="error-indicator"></span>
								</div>
								{{ form_errors(registrationForm.businessEmail) }}
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>

		<div class="pt-2">
			<button class="w-full bg-indigo-600 text-white py-2.5 px-4 rounded-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2" type="submit">
				Zarejestruj
			</button>
		</div>

		{{ form_end(registrationForm) }}

		<div class="text-center mt-4">
			<a href="{{ path('app_login') }}" class="text-indigo-600 hover:text-indigo-500">Posiadasz konto? Zaloguj się.</a>
		</div>
	</div>
</div>

{% endblock %}

{% block custom_scripts %}

  <script defer>

    (() => {
      
      const form = document.getElementById('registrationForm');
      if (!form) return;

      const formAlert = document.getElementById('formAlert');

      const businessFields = document.getElementById('businessFields');
      const formGrid = document.getElementById('formGrid');
      const radios = document.querySelectorAll('input[name="registration_form[accountType]"]');
      const indicator = document.getElementById('accountTypeIndicator');
      const btns = Array.from(document.querySelectorAll('.accountTypeBtn'));

      const getIsBusiness = () => radios.length > 1 && radios[1].checked;

      const emailOk = (value) => /^[^\s@]+@[^\s@]+\.[^\s@]{2,}$/i.test(String(value || '').trim());

      const getWrap = (input) => input?.closest('.field-wrap') || null;

      const clearError = (input) => {
        if (!input) return;
        input.classList.remove('is-invalid');

        const wrap = getWrap(input);
        const icon = wrap?.querySelector('.error-indicator');
        if (icon) {
          icon.classList.remove('is-visible');
          icon.removeAttribute('data-tip');
        }
      };

      const setError = (input, message) => {
        if (!input) return;
        input.classList.add('is-invalid');

        const wrap = getWrap(input);
        const icon = wrap?.querySelector('.error-indicator');
        if (icon) {
          icon.setAttribute('data-tip', message);
          icon.classList.add('is-visible');
        }
      };

      const isBusinessHiddenField = (input) => input?.matches('[data-business-only="1"]') && !getIsBusiness();

      const parseRules = (input) => String(input.getAttribute('data-validate') || '').split('|').map(s => s.trim()).filter(Boolean);

      const validateField = (input, { force = false } = {}) => {
        if (!input || !input.hasAttribute('data-validate')) return true;

        if (isBusinessHiddenField(input)) {
          clearError(input);
          return true;
        }

        const touched = input.dataset.touched === '1';
        if (!force && !touched) return true;

        const rules = parseRules(input);
        const value = (input.value ?? '').trim();

        for (const rule of rules) {
          if (rule === 'required') {
            if (!value) return setError(input, 'To pole jest wymagane.'), false;
          } else if (rule === 'email') {
            if (value && !emailOk(value)) return setError(input, 'Podaj poprawny adres e-mail.'), false;
          } else if (rule.startsWith('min:')) {
            const n = parseInt(rule.split(':')[1] || '0', 10);
            if (value.length < n) return setError(input, `Minimum ${n} znaków.`), false;
          }
        }

        const pass1 = form.querySelector('[data-password="first"]');
        const pass2 = form.querySelector('[data-password="second"]');

        if (pass1 && pass2) {
          const v1 = String(pass1.value || '');
          const v2 = String(pass2.value || '');

          if (input === pass2 && v1 && v2 && v1 !== v2) {
            return setError(pass2, 'Hasła muszą być identyczne.'), false;
          }

          if (input === pass1 && pass2.dataset.touched === '1') {
            clearError(pass2);
            validateField(pass2, { force: false });
          }
        }

        clearError(input);
        return true;
      };

      const validateAll = () => {
        let ok = true;

        const inputs = Array.from(form.querySelectorAll('[data-validate]'));

        for (const input of inputs) {
          input.dataset.touched = '1';
          clearError(input);
        }

        for (const input of inputs) {
          const res = validateField(input, { force: true });
          if (!res) ok = false;
        }

        const pass1 = form.querySelector('[data-password="first"]');
        const pass2 = form.querySelector('[data-password="second"]');
        if (pass1 && pass2) {
          const v1 = String(pass1.value || '');
          const v2 = String(pass2.value || '');
          if (v1 && v2 && v1 !== v2) {
            setError(pass2, 'Hasła muszą być identyczne.');
            ok = false;
          }
        }

        return ok;
      };

      const setIndicator = (index) => {
        if (indicator) indicator.style.transform = (index === 1) ? 'translateX(97%)' : 'translateX(0%)';
        btns.forEach((b, i) => b.classList.toggle('is-active', i === index));
      };

      const toggleBusinessUI = () => {
        const isBiznes = getIsBusiness();

        if (businessFields) businessFields.classList.toggle('hidden', !isBiznes);
        if (formGrid) formGrid.classList.toggle('reg-grid--single', !isBiznes);

        setIndicator(isBiznes ? 1 : 0);

        if (!isBiznes) {
          const bizInputs = form.querySelectorAll('[data-business-only="1"]');
          bizInputs.forEach((i) => clearError(i));
        }
      };

      let typKonta = "{{ typ_konta|default('uzytkownik')|e('js') }}".toLowerCase();
      if (typKonta !== 'uzytkownik' && typKonta !== 'biznes') typKonta = 'uzytkownik';

      const alreadyChecked = Array.from(radios).find(r => r.checked);
      if (!alreadyChecked && radios.length >= 2) {
        radios[1].checked = (typKonta === 'biznes');
        radios[0].checked = (typKonta !== 'biznes');
      }
      radios.forEach(r => r.addEventListener('change', toggleBusinessUI));
      toggleBusinessUI();

      const inputs = Array.from(form.querySelectorAll('[data-validate]'));

      inputs.forEach((input) => {
        input.addEventListener('blur', () => {
          input.dataset.touched = '1';
          validateField(input, { force: false });
        });

        input.addEventListener('input', () => {
          const touched = input.dataset.touched === '1';
          const wasInvalid = input.classList.contains('is-invalid');
          if (touched || wasInvalid) {
            validateField(input, { force: false });
          }
        });
      });

      form.addEventListener('submit', (e) => {
        const ok = validateAll();

        if (!ok) {
          e.preventDefault();
          e.stopPropagation();

          if (formAlert) formAlert.classList.remove('hidden');

          const firstInvalid = form.querySelector('.is-invalid');
          if (firstInvalid) firstInvalid.focus({ preventScroll: false });
          return;
        }

        if (formAlert) formAlert.classList.add('hidden');
      });
    
  })();

</script>

{% endblock %}