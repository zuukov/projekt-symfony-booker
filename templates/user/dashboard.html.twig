{% extends 'base.html.twig' %}

{% block title %}Booker - panel użytkownika{% endblock %}

{% block header %}
	{% include 'partials/header-alt.html.twig' %}
{% endblock %}

{% block body %}
<section class="user-dashboard bg-gray-100/70 py-10 sm:py-12">
	<div class="user-dashboard__container mx-auto w-[92%] max-w-6xl">
		<div class="user-dashboard__layout flex flex-col lg:flex-row gap-6">
			<aside class="user-dashboard__sidebar w-full lg:w-[320px] shrink-0">
				<div class="user-dashboard__card bg-white rounded-2xl shadow-sm border border-black/5 overflow-hidden">
					<div class="user-dashboard__profile flex items-center gap-4 p-5">
						<div class="user-dashboard__avatar relative shrink-0">
							<img src="{{ userData.avatarUrl }}" alt="{{ userData.fullName }}" class="h-14 w-14 rounded-full object-cover border border-black/10" >
						</div>

						<div class="min-w-0">
							<div class="user-dashboard__name font-semibold text-gray-900 truncate">
								{{ userData.fullName }}
							</div>
							<div class="user-dashboard__phone text-[14px] text-gray-500 truncate">
								{{ userData.phone ?: 'Brak numeru telefonu' }}
							</div>
						</div>
					</div>

					<div class="user-dashboard__nav border-t border-black/5">
						<nav class="user-dashboard__nav-list flex flex-col">
							{% for item in tabs %}
								<button type="button" class="user-dashboard__nav-link px-5 py-4 text-gray-700 hover:bg-gray-50 transition flex items-center gap-3 text-left" data-tab-trigger="{{ item.key }}">
									<i class="{{ item.icon }} text-gray-500"></i>
									<span>{{ item.label }}</span>
								</button>
								<div class="h-px bg-black/5"></div>
							{% endfor %}
						</nav>
					</div>
				</div>
			</aside>

			<div class="user-dashboard__content flex-1 min-w-0">
				<section id="tab-appointments" class="user-dashboard__tab" data-tab="appointments">
					<div class="bg-white rounded-2xl shadow-sm border border-black/5 p-6 sm:p-7">
						<div class="flex items-center justify-between gap-4 flex-wrap">
							<h1 class="text-[22px] sm:text-[24px] font-semibold text-gray-900">Wizyty</h1>
							<span class="text-gray-500">Historia</span>
						</div>

						{% if appointments is empty %}
							<div class="flex flex-col items-center justify-center py-14 text-center">
								<div class="w-full max-w-[360px]">
									<svg viewBox="0 0 800 400" class="w-full h-auto opacity-80">
										<path d="M105 290c60-90 200-155 340-110s205 160 280 120" fill="none" stroke="currentColor" stroke-width="10" class="text-gray-200"/>
										<rect x="255" y="120" width="290" height="190" rx="18" fill="currentColor" class="text-gray-100"/>
										<rect x="290" y="160" width="220" height="18" rx="9" fill="currentColor" class="text-gray-200"/>
										<rect x="290" y="195" width="180" height="18" rx="9" fill="currentColor" class="text-gray-200"/>
										<rect x="290" y="230" width="140" height="18" rx="9" fill="currentColor" class="text-gray-200"/>
										<circle cx="420" cy="90" r="28" fill="currentColor" class="text-gray-100"/>
									</svg>
								</div>
								<div class="mt-6 text-gray-900 font-semibold">Brak wizyt</div>
								<p class="mt-2 text-[14px] text-gray-600 max-w-[520px]">
									Wygląda na to, że nie masz jeszcze żadnych zakończonych wizyt.
									Gdy coś zarezerwujesz — pojawi się tutaj historia.
								</p>
								<a href="/" class="mt-6 inline-flex items-center justify-center px-5 py-3 rounded-xl bg-[#ff4757] text-white font-semibold text-[14px] hover:opacity-95 transition">
									Znajdź usługę
								</a>
							</div>
						{% else %}
							<div class="mt-6 flex flex-col gap-4">
								{% for ap in appointments %}
									<article class="user-dashboard__appt flex flex-col sm:flex-row sm:items-stretch gap-4 sm:gap-0 bg-white border border-black/5 rounded-2xl shadow-sm overflow-hidden">
										<div class="flex-1 p-5 sm:p-6">
											<div class="flex items-center justify-between gap-3 flex-wrap">
												<span class="inline-flex items-center px-3 py-1 rounded-full text-[12px] font-semibold
													{% if ap.statusTone == 'success' %} bg-emerald-50 text-emerald-700
													{% elseif ap.statusTone == 'warning' %} bg-amber-50 text-amber-700
													{% else %} bg-rose-50 text-rose-700 {% endif %}
												">
													{{ ap.statusLabel }}
												</span>
											</div>

											<div class="mt-3 text-gray-900 text-lg font-semibold">
												{{ ap.serviceName }}
											</div>

											<div class="mt-4 flex items-center gap-3">
												<img src="{{ ap.business.avatarUrl }}" alt="{{ ap.business.name }}" class="h-7 w-7 rounded-full object-cover border border-black/10" >
												<a href="{{ ap.business.url }}" class="text-gray-700 hover:underline">
													{{ ap.business.name }}
												</a>
											</div>

											<div class="mt-6">
												<a href="{{ ap.ctaUrl }}" class="inline-flex items-center justify-center px-5 py-2 rounded-lg bg-[#2f3542] text-white font-semibold text-[14px] hover:opacity-95 transition">
													{{ ap.ctaLabel }}
												</a>
											</div>
										</div>

										<div class="sm:w-[120px] sm:border-l border-black/5 bg-gray-50/60 flex sm:flex-col items-center justify-center p-4 gap-2">
											<div class="text-center leading-tight">
												<div class="text-[12px] text-gray-500 font-semibold">{{ ap.date.monthShort }}</div>
												<div class="text-[26px] font-extrabold text-gray-900">{{ ap.date.day }}</div>
												<div class="text-[12px] text-gray-500">{{ ap.date.year }}</div>
											</div>
											<div class="text-[12px] font-semibold text-gray-700">
												{{ ap.date.time }}
											</div>
										</div>
									</article>
								{% endfor %}
							</div>
						{% endif %}
					</div>
				</section>

				<section id="tab-payments" class="user-dashboard__tab hidden" data-tab="payments">
					<div class="bg-white rounded-2xl shadow-sm border border-black/5 p-6 sm:p-7">
						<div class="flex items-center justify-between gap-4 flex-wrap">
							<h2 class="text-[22px] sm:text-[24px] font-semibold text-gray-900">Płatności</h2>

							<div class="user-dashboard__subtabs inline-flex rounded-xl bg-gray-100 p-1">
								<button type="button" class="user-dashboard__subtab-btn px-4 py-2 font-semibold rounded-lg" data-subtab="methods">Metody płatności</button>
								<button type="button" class="user-dashboard__subtab-btn px-4 py-2 font-semibold rounded-lg" data-subtab="history">Historia płatności</button>
							</div>
						</div>

						<div class="mt-6">
							<div class="user-dashboard__subtab" data-subtab-panel="methods">
								{% if paymentMethods is empty %}
									<div class="flex flex-col items-center justify-center py-14 text-center">
										<div class="w-full max-w-[320px]">
											<svg viewBox="0 0 700 380" class="w-full h-auto opacity-80">
												<rect x="160" y="80" width="380" height="240" rx="22" fill="currentColor" class="text-gray-100"/>
												<rect x="190" y="125" width="320" height="26" rx="13" fill="currentColor" class="text-gray-200"/>
												<rect x="190" y="175" width="180" height="18" rx="9" fill="currentColor" class="text-gray-200"/>
												<rect x="190" y="205" width="240" height="18" rx="9" fill="currentColor" class="text-gray-200"/>
												<circle cx="470" cy="250" r="26" fill="currentColor" class="text-gray-200"/>
												<circle cx="505" cy="250" r="26" fill="currentColor" class="text-gray-200"/>
											</svg>
										</div>
										<div class="mt-6 text-gray-900 font-semibold text-[16px]">Brak metody płatności</div>
										<p class="mt-2 text-[14px] text-gray-600 max-w-[520px]">
											Dodaj kartę do profilu, aby płacić szybciej i wygodniej.
										</p>
										<button type="button" class="mt-6 inline-flex items-center justify-center px-6 py-3 rounded-xl bg-[#2f3542] text-white font-semibold text-[14px] hover:opacity-95 transition">
											Dodaj kartę
										</button>
									</div>
								{% else %}
									<div class="flex flex-col gap-4">
										{% for pm in paymentMethods %}
											<div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3 bg-gray-50/60 border border-black/5 rounded-2xl p-5">
												<div class="flex items-center gap-4 min-w-0">
													<div class="h-11 w-11 rounded-xl bg-white border border-black/5 flex items-center justify-center shrink-0">
														<i class="fa-regular fa-credit-card text-gray-600"></i>
													</div>
													<div class="min-w-0">
														<div class="text-[15px] font-semibold text-gray-900 truncate">
															{{ pm.brand }} •••• {{ pm.last4 }}
															{% if pm.isDefault %}
																<span class="ml-2 inline-flex items-center px-2 py-1 rounded-full text-[11px] font-semibold bg-emerald-50 text-emerald-700">Domyślna</span>
															{% endif %}
														</div>
														<div class="text-gray-500">Wygasa: {{ pm.exp }}</div>
													</div>
												</div>

												<div class="flex items-center gap-2">
													<button type="button" class="px-4 py-2 rounded-xl border border-black/10 bg-white font-semibold text-gray-700 hover:bg-gray-50 transition">Ustaw jako domyślną</button>
													<button type="button" class="px-4 py-2 rounded-xl border border-black/10 bg-white font-semibold text-gray-700 hover:bg-gray-50 transition">Usuń</button>
												</div>
											</div>
										{% endfor %}
									</div>
								{% endif %}
							</div>

							<div class="user-dashboard__subtab hidden" data-subtab-panel="history">
								{% if paymentHistory is empty %}
									<div class="flex flex-col items-center justify-center py-14 text-center">
										<div class="mt-2 text-gray-900 font-semibold text-[16px]">Brak historii płatności</div>
										<p class="mt-2 text-[14px] text-gray-600 max-w-[520px]">
											Gdy opłacisz wizytę online, transakcja pojawi się tutaj.
										</p>
									</div>
								{% else %}
									<div class="flex flex-col gap-3">
										{% for ph in paymentHistory %}
											<div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3 border border-black/5 rounded-2xl p-5 bg-white">
												<div class="min-w-0">
													<div class="text-[14px] font-semibold text-gray-900 truncate">{{ ph.businessName }}</div>
													<div class="text-[12px] text-gray-500">{{ ph.paidAt }} • {{ ph.status }}</div>
												</div>

												<div class="flex items-center justify-between sm:justify-end gap-3">
													<div class="text-[15px] font-extrabold text-gray-900">
														{{ ph.amount|number_format(2, '.', ' ') }} {{ ph.currency }}
													</div>
													<button type="button" class="px-4 py-2 rounded-xl border border-black/10 bg-gray-50 font-semibold text-gray-700 hover:bg-gray-100 transition">Pobierz</button>
												</div>
											</div>
										{% endfor %}
									</div>
								{% endif %}
							</div>
						</div>
					</div>
				</section>

				<section id="tab-reviews" class="user-dashboard__tab hidden" data-tab="reviews">
					<div class="bg-white rounded-2xl shadow-sm border border-black/5 p-6 sm:p-7">
						<div class="flex items-center justify-between gap-4 flex-wrap">
							<h2 class="text-[22px] sm:text-[24px] font-semibold text-gray-900">Opinie</h2>
							<span class="text-gray-500">Twoje wystawione opinie</span>
						</div>

						{% if reviews is empty %}
							<div class="flex flex-col items-center justify-center py-14 text-center">
								<div class="w-full max-w-[320px]">
									<svg viewBox="0 0 700 380" class="w-full h-auto opacity-80">
										<rect x="170" y="90" width="360" height="220" rx="22" fill="currentColor" class="text-gray-100"/>
										<path d="M260 210l40 40 80-90" fill="none" stroke="currentColor" stroke-width="16" class="text-gray-200" stroke-linecap="round" stroke-linejoin="round"/>
										<rect x="230" y="140" width="240" height="18" rx="9" fill="currentColor" class="text-gray-200"/>
									</svg>
								</div>
								<div class="mt-6 text-gray-900 font-semibold text-[16px]">Brak opinii</div>
								<p class="mt-2 text-[14px] text-gray-600 max-w-[520px]">
									Po wizycie możesz ocenić usługę i pomóc innym w wyborze.
								</p>
							</div>
						{% else %}
							<div class="mt-6 flex flex-col gap-4">
								{% for r in reviews %}
									<article class="border border-black/5 rounded-2xl p-5 bg-gray-50/60">
										<div class="flex items-start sm:items-center justify-between gap-4 flex-col sm:flex-row">
											<a href="{{ r.businessUrl }}" class="text-lg font-semibold text-gray-900 hover:underline">{{ r.businessName }}</a>
											<div class="flex items-center gap-3">
												<div class="flex items-center gap-1">
													{% for i in 1..5 %}
														<i class="fa-solid fa-star {{ i <= r.rating ? 'text-yellow-400' : 'text-gray-300' }}"></i>
													{% endfor %}
												</div>
												<span class="text-[13px] text-gray-500">{{ r.createdAt }}</span>
											</div>
										</div>

										<p class="mt-3 text-gray-700 leading-relaxed">
											{{ r.text }}
										</p>

										<div class="mt-4">
											<a href="{{ r.businessUrl }}" class="text-[13px] font-semibold text-[#2f3542] hover:underline inline-flex items-center gap-2">
												Zobacz stronę i opinie
												<i class="fa-solid fa-arrow-up-right-from-square text-[12px]"></i>
											</a>
										</div>
									</article>
								{% endfor %}
							</div>
						{% endif %}
					</div>
				</section>

				<section id="tab-settings" class="user-dashboard__tab hidden" data-tab="settings">
					<div class="bg-white rounded-2xl shadow-sm border border-black/5 p-6 sm:p-7">
						<div class="flex items-center justify-between gap-4 flex-wrap">
							<h2 class="text-[22px] sm:text-[24px] font-semibold text-gray-900">Ustawienia konta</h2>
							<span class="text-gray-500">Zaktualizuj dane profilu</span>
						</div>

						<form action="#" method="post" class="mt-6 flex flex-col gap-5">
							<div class="flex flex-col gap-2">
								<label class="font-semibold text-gray-700">Imię i nazwisko</label>
								<input type="text" name="fullName" value="{{ userData.fullName }}" class="w-full rounded-xl border border-black/10 bg-white px-4 py-3 text-[14px] outline-none focus:ring-2 focus:ring-black/10" autocomplete="name">
							</div>

							<div class="flex flex-col gap-2">
								<label class="font-semibold text-gray-700">E-mail</label>
								<div class="flex items-stretch gap-2 flex-col sm:flex-row">
									<input type="email" name="email" value="{{ userData.email }}" class="flex-1 rounded-xl border border-black/10 bg-white px-4 py-3 text-[14px] outline-none focus:ring-2 focus:ring-black/10" autocomplete="email">
								</div>
							</div>

							<div class="flex flex-col gap-2">
								<label class="font-semibold text-gray-700">Numer telefonu</label>
								<div class="flex items-stretch gap-2 flex-col sm:flex-row">
									<input type="tel" name="phone" value="{{ userData.phone }}" class="flex-1 rounded-xl border border-black/10 bg-white px-4 py-3 text-[14px] outline-none focus:ring-2 focus:ring-black/10" autocomplete="tel">
								</div>
							</div>

							<div class="rounded-2xl border border-black/5 bg-gray-50/60 p-5">
								<div class="flex items-center justify-between gap-4 flex-wrap">
									<div>
										<div class="font-semibold text-gray-900">Hasło</div>
										<div class="text-[14px] text-gray-500">Zmieniaj hasło regularnie</div>
									</div>
									<button type="button" class="user-dashboard__toggle-pass px-4 py-2 rounded-xl bg-white border border-black/10 font-semibold text-gray-700 hover:bg-gray-50 transition">Zmień hasło</button>
								</div>

								<div class="user-dashboard__pass-panel hidden mt-4">
									<div class="flex flex-col gap-4">
										<div class="flex flex-col gap-2">
											<label class="font-semibold text-gray-700">Aktualne hasło</label>
											<input type="password" name="currentPassword" class="w-full rounded-xl border border-black/10 bg-white px-4 py-3 text-[14px] outline-none focus:ring-2 focus:ring-black/10">
										</div>
										<div class="flex flex-col gap-2">
											<label class="font-semibold text-gray-700">Nowe hasło</label>
											<input type="password" name="newPassword" class="w-full rounded-xl border border-black/10 bg-white px-4 py-3 text-[14px] outline-none focus:ring-2 focus:ring-black/10">
										</div>
										<div class="flex flex-col gap-2">
											<label class="font-semibold text-gray-700">Powtórz nowe hasło</label>
											<input type="password" name="newPasswordRepeat" class="w-full rounded-xl border border-black/10 bg-white px-4 py-3 text-[14px] outline-none focus:ring-2 focus:ring-black/10">
										</div>
									</div>
								</div>
							</div>

							<div class="flex items-center gap-3 flex-col sm:flex-row sm:justify-end">
								<button type="button" class="w-full sm:w-auto px-6 py-3 rounded-xl border border-black/10 bg-white text-[14px] font-semibold text-gray-700 hover:bg-gray-50 transition">Anuluj</button>
								<button type="submit" class="w-full sm:w-auto px-6 py-3 rounded-xl bg-[#ff4757] text-white text-[14px] font-semibold hover:opacity-95 transition">Zapisz zmiany</button>
							</div>
						</form>
					</div>
				</section>
			</div>
		</div>
	</div>
</section>
{% endblock %}

{% block custom_scripts %}

<script>

    (() => {
        const defaultTab = {{ defaultTab|json_encode|raw }};
        const triggers = Array.from(document.querySelectorAll('[data-tab-trigger]'));
        const panels = Array.from(document.querySelectorAll('.user-dashboard__tab[data-tab]'));

        function setActiveTab(key) {
            panels.forEach(p => {
                const isMatch = p.getAttribute('data-tab') === key;
                p.classList.toggle('hidden', !isMatch);
            });

            triggers.forEach(btn => {
                const isActive = btn.getAttribute('data-tab-trigger') === key;
                btn.classList.toggle('is-active', isActive);
            });
        }

        triggers.forEach(btn => {
            btn.addEventListener('click', () => setActiveTab(btn.getAttribute('data-tab-trigger')));
        });

        setActiveTab(defaultTab);

        const subBtns = Array.from(document.querySelectorAll('.user-dashboard__subtab-btn[data-subtab]'));
        const subPanels = Array.from(document.querySelectorAll('.user-dashboard__subtab[data-subtab-panel]'));

        function setActiveSubtab(key) {
            subPanels.forEach(p => p.classList.toggle('hidden', p.getAttribute('data-subtab-panel') !== key));
            subBtns.forEach(b => b.classList.toggle('is-active', b.getAttribute('data-subtab') === key));
        }

        if (subBtns.length && subPanels.length) {
            subBtns.forEach(b => b.addEventListener('click', () => setActiveSubtab(b.getAttribute('data-subtab'))));
            setActiveSubtab('methods');
        }

        const togglePassBtn = document.querySelector('.user-dashboard__toggle-pass');

        const passPanel = document.querySelector('.user-dashboard__pass-panel');
        
        if (togglePassBtn && passPanel) {
            togglePassBtn.addEventListener('click', () => {
                const isOpen = !passPanel.classList.contains('hidden');
                passPanel.classList.toggle('hidden', isOpen);
            });
        }
    })();

</script>

{% endblock %}