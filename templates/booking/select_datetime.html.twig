{% extends 'base.html.twig' %}

{% block title %}Wybierz termin - {{ service.name }}{% endblock %}

{% block body %}
<div class="max-w-7xl mx-auto mt-8 pt-6 min-h-[70vh] pb-20">
    <div class="w-full">
        <nav class="mb-6" aria-label="breadcrumb">
            <ol class="flex space-x-2 text-sm text-gray-600">
                <li><a href="{{ path('app_home') }}" class="hover:text-indigo-600">Strona główna</a></li>
                <li class="before:content-['/'] before:mx-2"><a href="{{ path('booking_select_staff', {businessId: business.id, serviceId: service.id}) }}" class="hover:text-indigo-600">{{ service.name }}</a></li>
                <li class="before:content-['/'] before:mx-2 text-gray-900">Wybierz termin</li>
            </ol>
        </nav>

        <h1 class="text-3xl font-bold text-gray-900 mb-6">Wybierz datę i godzinę</h1>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <div class="lg:col-span-1">
                <div class="bg-white rounded-lg shadow mb-4">
                    <div class="border-b border-gray-200 px-6 py-4">
                        <h5 class="text-lg font-semibold text-gray-900">Podsumowanie</h5>
                    </div>
                    <div class="p-6">
                        <p class="mb-3"><strong class="text-gray-700">Firma:</strong> <span class="text-gray-900">{{ business.businessName }}</span></p>
                        <p class="mb-3"><strong class="text-gray-700">Usługa:</strong> <span class="text-gray-900">{{ service.name }}</span></p>
                        <p class="mb-3"><strong class="text-gray-700">Pracownik:</strong> <span class="text-gray-900">{{ staff.name }} {{ staff.surname }}</span></p>
                        <p class="mb-3"><strong class="text-gray-700">Czas trwania:</strong> <span class="text-gray-900">{{ service.durationMinutes }} minut</span></p>
                        <p class="mb-0"><strong class="text-gray-700">Cena:</strong> <span class="text-gray-900">{{ service.price }} PLN</span></p>
                    </div>
                </div>
            </div>

            <div class="lg:col-span-2">
                <div class="bg-white rounded-lg shadow">
                    <div class="border-b border-gray-200 px-6 py-4">
                        <h5 class="text-lg font-semibold text-gray-900">Wybierz datę</h5>
                    </div>
                    <div class="p-6">
                        <div class="mb-4">
                            <input type="date" id="booking-date" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500" min="{{ 'now'|date('Y-m-d') }}">
                        </div>

                        <div id="slots-container">
                            <p class="text-gray-600">Wybierz datę, aby zobaczyć dostępne terminy.</p>
                        </div>

                        <div id="loading-spinner" class="text-center" style="display: none;">
                            <div class="inline-block animate-spin rounded-full h-8 w-8 border-4 border-gray-300 border-t-indigo-600"></div>
                            <p class="text-gray-600 mt-2">Ładowanie...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<form id="booking-form" method="post" action="{{ path('booking_create') }}" style="display: none;">
    <input type="hidden" name="staff_id" value="{{ staff.id }}">
    <input type="hidden" name="service_id" value="{{ service.id }}">
    <input type="hidden" name="starts_at" id="selected-slot">
</form>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const dateInput = document.getElementById('booking-date');
    const slotsContainer = document.getElementById('slots-container');
    const loadingSpinner = document.getElementById('loading-spinner');
    const bookingForm = document.getElementById('booking-form');
    const selectedSlotInput = document.getElementById('selected-slot');

    dateInput.addEventListener('change', function() {
        const selectedDate = this.value;

        if (!selectedDate) {
            return;
        }

        slotsContainer.innerHTML = '';
        loadingSpinner.style.display = 'block';

        const url = `{{ path('api_booking_slots') }}?staffId={{ staff.id }}&serviceId={{ service.id }}&date=${selectedDate}`;

        fetch(url)
            .then(response => response.json())
            .then(data => {
                loadingSpinner.style.display = 'none';

                if (!data.success) {
                    slotsContainer.innerHTML = '<div class="p-4 text-red-800 bg-red-100 border border-red-200 rounded-lg">Błąd: ' + (data.error || 'Nieznany błąd') + '</div>';
                    return;
                }

                if (data.slots.length === 0) {
                    slotsContainer.innerHTML = '<div class="p-4 text-blue-800 bg-blue-100 border border-blue-200 rounded-lg">Brak dostępnych terminów w tym dniu.</div>';
                    return;
                }

                const slotsHTML = '<h6 class="text-lg font-semibold text-gray-900 mb-4">Dostępne terminy:</h6><div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-3">' +
                    data.slots.map(slot => `
                        <button type="button" class="px-4 py-2 border border-indigo-600 text-indigo-600 rounded-md hover:bg-indigo-50 slot-button" data-datetime="${slot.datetime}">
                            ${slot.time}
                        </button>
                    `).join('') +
                    '</div>';

                slotsContainer.innerHTML = slotsHTML;

                document.querySelectorAll('.slot-button').forEach(button => {
                    button.addEventListener('click', function() {
                        const datetime = this.getAttribute('data-datetime');
                        const time = this.textContent.trim();

                        if (confirm(`Czy na pewno chcesz zarezerwować termin ${selectedDate} o godzinie ${time}?`)) {
                            selectedSlotInput.value = datetime;
                            bookingForm.submit();
                        }
                    });
                });
            })
            .catch(error => {
                loadingSpinner.style.display = 'none';
                slotsContainer.innerHTML = '<div class="p-4 text-red-800 bg-red-100 border border-red-200 rounded-lg">Wystąpił błąd podczas ładowania terminów.</div>';
                console.error('Error:', error);
            });
    });
});
</script>
{% endblock %}
